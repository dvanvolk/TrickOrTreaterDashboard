<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÉ Trick-or-Treater Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÉ CNY Trick-or-Treater Counter üëª</h1>
            <p>Live counting of Halloween visitors</p>
            <div style="margin-top: 15px;">
                <span id="status">Light Status: <span id="liveStatus">On</span> <span class="status-indicator" id="statusIndicator"></span></span>
                <span id="liveTimeContainer" style="display:none; margin-left: 30px; font-size: 1.1em; color: #ff6b35;">‚è±Ô∏è Live Time: <span id="liveTimer">00:00</span></span>
                <span id="weatherContainer" style="display:none; margin-left: 30px; font-size: 1.1em; color: #4ecdc4;">
                    üå§Ô∏è <span id="weatherCondition">Clear</span> | <span id="weatherTemp">72</span>¬∞F
                </span>
            </div>
            <div id="summaryContainer" style="display:none; margin-top: 20px; padding: 20px; background: rgba(255,107,53,0.2); border-radius: 10px; border: 2px solid #ff6b35;">
                <!-- Summary content will be inserted here by JavaScript -->
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalToday">0</div>
                <div class="stat-label">Total Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentMinute">0</div>
                <div class="stat-label">This 5 Minutes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="peakMinute">--</div>
                <div class="stat-label">Peak 10-Min</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgPerMinute">0.0</div>
                <div class="stat-label">Avg/Min</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastVisitor">--</div>
                <div class="stat-label">Last Visitor</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">üìä 10-Minute Distribution</div>
                <canvas id="minuteChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üìà Running Total Timeline</div>
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <div class="chart-container full-width">
            <div class="chart-title">üìà Year-over-Year Comparison</div>
            <canvas id="yearComparisonChart"></canvas>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">üìä Year Summary Statistics</div>
                <canvas id="yearStatsChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üî• Peak Activity Times</div>
                <canvas id="peakActivityChart"></canvas>
            </div>
        </div>

        <!-- Detailed per-arrival charts for a selected year (default 2024) -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">üïí Detailed Arrival Minutes (per minute) ‚Äî Year: <span id="detailedYearLabel">2024</span>
                    <select id="yearSelector" style="margin-left:12px;">
                        <!-- populated dynamically -->
                    </select>
                </div>
                <canvas id="detailedYearChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">‚ú® Visitor Scatter (each dot is one visitor)</div>
                <canvas id="detailedScatterChart"></canvas>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/chart-helpers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        // Adaptive live-status poller with backoff and Retry-After handling.
        (function() {
            let pollIntervalMs = 2000;
            const MIN_POLL = 2000;
            const MAX_POLL = 60000;

            async function checkLiveStatus() {
                try {
                    const response = await fetch('/live_status');

                    if (response.status === 429) {
                        console.warn('/live_status returned 429 Too Many Requests');
                        const retryAfter = response.headers.get('Retry-After');
                        let delay = pollIntervalMs * 2;
                        if (retryAfter) {
                            const ra = parseInt(retryAfter, 10);
                            if (!isNaN(ra)) delay = Math.max(delay, ra * 1000);
                        }
                        pollIntervalMs = Math.min(delay, MAX_POLL);
                        console.info(`Backoff: next live-status check in ${pollIntervalMs}ms`);
                        try {
                            const text = await response.text();
                            console.debug('Live status response (429 body):', text.slice(0, 400));
                        } catch(e) { /* ignore body read errors */ }
                        setTimeout(checkLiveStatus, pollIntervalMs);
                        return;
                    }

                    if (!response.ok) {
                        console.warn(`/live_status returned HTTP ${response.status}`);
                        pollIntervalMs = Math.min(pollIntervalMs * 2, MAX_POLL);
                        setTimeout(checkLiveStatus, pollIntervalMs);
                        return;
                    }

                    const contentType = response.headers.get('content-type') || '';
                    if (!contentType.includes('application/json')) {
                        const text = await response.text();
                        console.warn('Unexpected non-JSON response from /live_status:', text.slice(0, 400));
                        pollIntervalMs = Math.min(pollIntervalMs * 2, MAX_POLL);
                        setTimeout(checkLiveStatus, pollIntervalMs);
                        return;
                    }

                    const data = await response.json();

                    pollIntervalMs = MIN_POLL;

                    // Detect transition from live to non-live
                    const wasLive = liveStatus;
                    const nowLive = data.live;

                    if (wasLive && !nowLive) {
                        // Live mode was just disabled - save summary
                        console.info('Live mode disabled - saving session summary');
                        saveSummaryData();
                    } else if (!wasLive && nowLive) {
                        // Live mode was just enabled - clear summary
                        console.info('Live mode enabled - clearing previous summary');
                        clearSummaryData();
                    }

                    if (nowLive !== liveStatus) {
                        console.info(`/live_status Debug ${nowLive}, ${liveStatus}`);
                        liveStatus = nowLive;
                        updateLiveStatusDisplay();
                        updateStatsVisibility();
                    }

                    // Update HH:MM live timer from server elapsed seconds
                    const seconds = data.elapsed_seconds || 0;
                    const minutes = Math.floor(seconds / 60);
                    const hours = Math.floor(minutes / 60);
                    const mm = String(minutes % 60).padStart(2, '0');
                    const hh = String(hours).padStart(2, '0');
                    document.getElementById('liveTimer').textContent = `${hh}:${mm}`;

                    setTimeout(checkLiveStatus, pollIntervalMs);
                } catch (error) {
                    console.error('Error checking live status (network/parse):', error);
                    pollIntervalMs = Math.min(Math.max(pollIntervalMs * 2, MIN_POLL), MAX_POLL);
                    console.info(`Live-status fetch failed; retrying in ${pollIntervalMs}ms`);
                    setTimeout(checkLiveStatus, pollIntervalMs);
                }
            }

            checkLiveStatus();
        })();
    </script>
</body>
</html>